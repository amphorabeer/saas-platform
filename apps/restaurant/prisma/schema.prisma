// Restaurant app uses landing DB — schema for client generation only (no db push)

generator client {
  provider = "prisma-client-js"
  output   = "./generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id           String   @id @default(cuid())
  name         String
  slug         String   @unique
  email        String
  phone        String?
  address      String?
  logo         String?
  company      String?
  taxId        String?
  city         String?
  country      String?  @default("Georgia")
  website      String?
  bankName     String?
  bankAccount  String?
  directorName String?
  bankSWIFT    String?
  tenantId     String   @unique @default(cuid())
  hotelCode    String?  @unique
  storeCode    String?  @unique
  restCode     String?  @unique
  databaseUrl  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  users        User[]

  @@index([slug])
  @@index([tenantId])
}

model User {
  id             String        @id @default(cuid())
  email          String        @unique
  name           String?
  password       String
  avatar         String?
  emailVerified  DateTime?
  lastLoginAt    DateTime?
  organizationId String?
  role           Role          @default(USER)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@index([email])
  @@index([organizationId])
}

enum Role {
  SUPER_ADMIN
  ORGANIZATION_OWNER
  MODULE_ADMIN
  MANAGER
  USER
}

model Restaurant {
  id             String    @id @default(cuid())
  tenantId       String
  name           String
  slug           String    @unique
  type           String    @default("restaurant")
  address        String?
  phone          String?
  email          String?
  taxId          String?
  currency       String    @default("GEL")
  timezone       String    @default("Asia/Tbilisi")
  logoUrl        String?
  isActive       Boolean   @default(true)
  settings       Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  employees      RestaurantEmployee[]
  zones          RestaurantZone[]
  tables         RestaurantTable[]
  menuCategories MenuCategory[]
  menuItems      MenuItem[]
  modifierGroups MenuModifierGroup[]
  comboSets      ComboSet[]
  orders         RestaurantOrder[]
  kitchenTickets KitchenTicket[]
  assignments    WaiterAssignment[]
  tips           Tip[]
  ingredients    Ingredient[]
  recipes        Recipe[]
  operations     IngredientOperation[]
  reservations   Reservation[]
  invoices          RestaurantInvoice[]
  purchaseInvoices  PurchaseInvoice[]
  expenseCategories ExpenseCategory[]
  expenses          Expense[]
  suppliers         Supplier[]

  @@index([tenantId])
}

model RestaurantEmployee {
  id           String                @id @default(cuid())
  restaurantId String
  userId       String?
  firstName    String
  lastName     String
  phone        String?
  email        String?
  role         RestaurantEmployeeRole @default(WAITER)
  pin          String?
  isActive     Boolean               @default(true)
  photoUrl     String?
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  restaurant   Restaurant           @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  sessions     TableSession[]
  assignments  WaiterAssignment[]
  tips         Tip[]
  orders       RestaurantOrder[]

  @@index([restaurantId])
}

enum RestaurantEmployeeRole {
  RESTAURANT_OWNER
  MANAGER
  WAITER
  BARTENDER
  CHEF
  HOST
  CASHIER
}

model RestaurantZone {
  id           String           @id @default(cuid())
  restaurantId String
  name         String
  color        String?
  sortOrder    Int              @default(0)
  isActive     Boolean          @default(true)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  restaurant   Restaurant       @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  tables       RestaurantTable[]

  @@index([restaurantId])
}

model RestaurantTable {
  id           String           @id @default(cuid())
  restaurantId String
  zoneId       String
  number       String
  label        String?
  seats        Int              @default(4)
  shape        TableShape       @default(RECTANGLE)
  status       TableStatus      @default(FREE)
  posX         Int              @default(0)
  posY         Int              @default(0)
  width        Int              @default(100)
  height       Int              @default(80)
  rotation     Int              @default(0)
  isActive     Boolean          @default(true)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  restaurant   Restaurant       @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  zone         RestaurantZone   @relation(fields: [zoneId], references: [id], onDelete: Cascade)
  sessions     TableSession[]
  orders       RestaurantOrder[]
  assignments  WaiterAssignment[]
  reservations Reservation[]

  @@unique([restaurantId, number])
  @@index([restaurantId])
  @@index([zoneId])
}

enum TableShape {
  ROUND
  SQUARE
  RECTANGLE
}

enum TableStatus {
  FREE
  OCCUPIED
  RESERVED
  CLEANING
  BILLING
}

model TableSession {
  id         String             @id @default(cuid())
  tableId    String
  waiterId   String?
  guestCount Int                @default(0)
  startedAt  DateTime           @default(now())
  endedAt    DateTime?
  isActive   Boolean            @default(true)
  createdAt  DateTime          @default(now())
  table      RestaurantTable   @relation(fields: [tableId], references: [id], onDelete: Cascade)
  waiter     RestaurantEmployee? @relation(fields: [waiterId], references: [id])
  orders     RestaurantOrder[]

  @@index([tableId])
  @@index([waiterId])
}

model MenuCategory {
  id           String        @id @default(cuid())
  restaurantId String
  name         String
  nameEn       String?
  icon         String?
  color        String?
  sortOrder    Int           @default(0)
  isActive     Boolean       @default(true)
  isSeasonal   Boolean       @default(false)
  parentId     String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  restaurant   Restaurant    @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  parent       MenuCategory? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children     MenuCategory[] @relation("CategoryHierarchy")
  items        MenuItem[]

  @@index([restaurantId])
  @@index([parentId])
}

model MenuItem {
  id              String       @id @default(cuid())
  restaurantId    String
  categoryId      String
  name            String
  nameEn          String?
  description     String?
  descriptionEn   String?
  price           Decimal      @db.Decimal(10, 2)
  imageUrl        String?
  preparationTime  Int?
  calories        Int?
  allergens       String[]
  kdsStation      KDSStation   @default(HOT)
  isActive        Boolean      @default(true)
  isFavorite      Boolean      @default(false)
  sortOrder       Int          @default(0)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  restaurant      Restaurant   @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  category        MenuCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  modifierGroups  MenuItemModifierGroup[]
  orderItems      RestaurantOrderItem[]
  recipe          Recipe?
  comboItems      ComboSetItem[]

  @@index([restaurantId])
  @@index([categoryId])
}

enum KDSStation {
  HOT
  COLD
  BAR
  PIZZA
  GRILL
  PASTRY
}

model MenuModifierGroup {
  id           String                 @id @default(cuid())
  restaurantId String
  name         String
  nameEn       String?
  isRequired   Boolean                @default(false)
  minSelect    Int                    @default(0)
  maxSelect    Int                    @default(1)
  sortOrder    Int                    @default(0)
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt
  restaurant   Restaurant             @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  modifiers    MenuModifier[]
  menuItems    MenuItemModifierGroup[]

  @@index([restaurantId])
}

model MenuModifier {
  id             String           @id @default(cuid())
  groupId        String
  name           String
  nameEn         String?
  priceAdjustment Decimal         @db.Decimal(10, 2)
  isDefault      Boolean          @default(false)
  isActive       Boolean          @default(true)
  sortOrder      Int              @default(0)
  createdAt      DateTime         @default(now())
  group          MenuModifierGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([groupId])
}

model MenuItemModifierGroup {
  id             String           @id @default(cuid())
  menuItemId     String
  modifierGroupId String
  sortOrder      Int              @default(0)
  menuItem       MenuItem         @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  modifierGroup  MenuModifierGroup @relation(fields: [modifierGroupId], references: [id], onDelete: Cascade)

  @@unique([menuItemId, modifierGroupId])
  @@index([menuItemId])
  @@index([modifierGroupId])
}

model ComboSet {
  id           String         @id @default(cuid())
  restaurantId String
  name         String
  nameEn       String?
  description  String?
  price        Decimal        @db.Decimal(10, 2)
  isActive     Boolean        @default(true)
  validFrom    DateTime?
  validTo      DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  restaurant   Restaurant     @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  items        ComboSetItem[]

  @@index([restaurantId])
}

model ComboSetItem {
  id         String    @id @default(cuid())
  comboSetId String
  menuItemId String
  quantity   Int       @default(1)
  comboSet   ComboSet  @relation(fields: [comboSetId], references: [id], onDelete: Cascade)
  menuItem   MenuItem  @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  @@index([comboSetId])
  @@index([menuItemId])
}

model RestaurantOrder {
  id               String      @id @default(cuid())
  restaurantId     String
  orderNumber      String
  tableSessionId   String?
  tableId          String?
  waiterId         String?
  orderType        OrderType  @default(DINE_IN)
  status           OrderStatus @default(DRAFT)
  subtotal         Decimal   @db.Decimal(10, 2)
  taxAmount        Decimal   @default(0) @db.Decimal(10, 2)
  discountAmount   Decimal   @default(0) @db.Decimal(10, 2)
  tipAmount        Decimal   @default(0) @db.Decimal(10, 2)
  totalAmount      Decimal   @db.Decimal(10, 2)
  paymentMethod    String?
  paidAmount       Decimal   @default(0) @db.Decimal(10, 2)
  changeAmount     Decimal   @default(0) @db.Decimal(10, 2)
  customerName     String?
  customerPhone    String?
  deliveryAddress  String?
  notes            String?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  paidAt           DateTime?
  restaurant       Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  table            RestaurantTable? @relation(fields: [tableId], references: [id])
  waiter           RestaurantEmployee? @relation(fields: [waiterId], references: [id])
  tableSession     TableSession? @relation(fields: [tableSessionId], references: [id])
  items            RestaurantOrderItem[]
  kitchenTickets   KitchenTicket[]
  splitPayments    OrderSplitPayment[]
  tips             Tip[]
  invoices         RestaurantInvoice[]

  @@unique([restaurantId, orderNumber])
  @@index([restaurantId])
  @@index([tableId])
  @@index([waiterId])
}

enum OrderType {
  DINE_IN
  TAKEAWAY
  DELIVERY
}

enum OrderStatus {
  DRAFT
  CONFIRMED
  IN_PROGRESS
  READY
  SERVED
  PAID
  CANCELLED
}

model RestaurantOrderItem {
  id                String             @id @default(cuid())
  orderId           String
  menuItemId        String
  menuItemName      String
  quantity          Decimal             @db.Decimal(10, 3)
  unitPrice         Decimal             @db.Decimal(10, 2)
  totalPrice        Decimal             @db.Decimal(10, 2)
  modifiers         Json?
  specialInstructions String?
  kdsStation        KDSStation?
  status            KitchenTicketStatus @default(NEW)
  createdAt         DateTime            @default(now())
  order             RestaurantOrder     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem          MenuItem?           @relation(fields: [menuItemId], references: [id])

  @@index([orderId])
  @@index([menuItemId])
}

model OrderSplitPayment {
  id            String           @id @default(cuid())
  orderId       String
  amount        Decimal          @db.Decimal(10, 2)
  paymentMethod String
  paidBy        String?
  createdAt     DateTime         @default(now())
  order         RestaurantOrder  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
}

model KitchenTicket {
  id           String              @id @default(cuid())
  restaurantId String
  orderId      String
  station      KDSStation
  status       KitchenTicketStatus @default(NEW)
  items        Json
  tableNumber  String?
  waiterName   String?
  priority     Int                 @default(0)
  startedAt    DateTime?
  completedAt  DateTime?
  createdAt    DateTime            @default(now())
  restaurant   Restaurant         @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  order        RestaurantOrder    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([orderId])
}

enum KitchenTicketStatus {
  NEW
  PREPARING
  READY
  SERVED
  CANCELLED
}

model WaiterAssignment {
  id           String             @id @default(cuid())
  restaurantId String
  employeeId   String
  tableId      String
  assignedAt   DateTime           @default(now())
  unassignedAt DateTime?
  isActive     Boolean            @default(true)
  restaurant   Restaurant        @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  employee     RestaurantEmployee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  table        RestaurantTable    @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([employeeId])
  @@index([tableId])
}

model Tip {
  id           String             @id @default(cuid())
  restaurantId String
  orderId      String
  employeeId   String?
  amount       Decimal            @db.Decimal(10, 2)
  isPool       Boolean            @default(false)
  createdAt    DateTime           @default(now())
  restaurant   Restaurant         @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  order        RestaurantOrder    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  employee     RestaurantEmployee? @relation(fields: [employeeId], references: [id])

  @@index([restaurantId])
  @@index([orderId])
}

model Ingredient {
  id            String    @id @default(cuid())
  restaurantId String
  name          String
  nameEn        String?
  unit          String
  currentStock  Decimal   @default(0) @db.Decimal(12, 4)
  minimumStock  Decimal   @default(0) @db.Decimal(12, 4)
  costPerUnit   Decimal?   @db.Decimal(10, 4)
  supplierId    String?
  expiryDate    DateTime?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  restaurant    Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  recipes       RecipeIngredient[]
  operations    IngredientOperation[]
  purchaseItems PurchaseInvoiceItem[]

  @@index([restaurantId])
}

model Recipe {
  id          String    @id @default(cuid())
  menuItemId  String    @unique
  restaurantId String
  yield       Decimal   @db.Decimal(10, 3)
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  menuItem    MenuItem  @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  restaurant  Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  ingredients RecipeIngredient[]

  @@index([restaurantId])
}

model RecipeIngredient {
  id          String    @id @default(cuid())
  recipeId    String
  ingredientId String
  quantity    Decimal   @db.Decimal(12, 4)
  recipe      Recipe    @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)

  @@index([recipeId])
  @@index([ingredientId])
}

model IngredientOperation {
  id           String                 @id @default(cuid())
  restaurantId String
  ingredientId String
  type         InventoryOperationType
  quantity     Decimal                @db.Decimal(12, 4)
  unitCost     Decimal?               @db.Decimal(10, 4)
  reference    String?
  notes        String?
  performedBy  String?
  createdAt    DateTime               @default(now())
  restaurant   Restaurant             @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  ingredient   Ingredient             @relation(fields: [ingredientId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([ingredientId])
}

enum InventoryOperationType {
  INCOMING
  WRITE_OFF
  ADJUSTMENT
  TRANSFER
  AUTO_DEDUCTION
}

model Reservation {
  id           String            @id @default(cuid())
  restaurantId String
  tableId      String?
  guestName    String
  guestPhone   String?
  guestEmail   String?
  guestCount   Int               @default(1)
  date         DateTime          @db.Date
  time         DateTime          @db.Time(0)
  duration     Int?
  status       ReservationStatus @default(PENDING)
  notes        String?
  smsSent      Boolean           @default(false)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  restaurant   Restaurant       @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  table        RestaurantTable?  @relation(fields: [tableId], references: [id])

  @@index([restaurantId])
  @@index([tableId])
  @@index([date])
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  SEATED
  COMPLETED
  CANCELLED
  NO_SHOW
}

// ===== ფინანსური მოდული =====

model Supplier {
  id            String              @id @default(cuid())
  restaurantId  String
  name          String
  taxId         String?
  contact       String?
  email         String?
  address       String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  restaurant    Restaurant          @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  purchaseInvoices PurchaseInvoice[]

  @@index([restaurantId])
}

// ===== ინვოისი (გაცემა მომხმარებლებზე) =====

model RestaurantInvoice {
  id              String          @id @default(cuid())
  restaurantId    String
  invoiceNumber   String
  type            InvoiceType     @default(SALE)
  customerName    String
  customerPhone   String?
  customerEmail   String?
  customerAddress String?
  customerTaxId   String?
  issueDate       DateTime        @default(now())
  dueDate         DateTime?
  paidAt          DateTime?
  subtotal        Decimal         @default(0) @db.Decimal(12,2)
  taxRate         Decimal         @default(0) @db.Decimal(5,2)
  taxAmount       Decimal         @default(0) @db.Decimal(12,2)
  discountAmount  Decimal         @default(0) @db.Decimal(12,2)
  totalAmount     Decimal         @default(0) @db.Decimal(12,2)
  paidAmount      Decimal         @default(0) @db.Decimal(12,2)
  status          InvoiceStatus   @default(DRAFT)
  notes           String?
  orderId         String?
  restaurant      Restaurant      @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  order           RestaurantOrder? @relation(fields: [orderId], references: [id])
  items           RestaurantInvoiceItem[]
  payments        RestaurantInvoicePayment[]
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  @@unique([restaurantId, invoiceNumber])
  @@index([restaurantId])
  @@index([status])
  @@index([dueDate])
  @@map("RestaurantInvoice")
}

model RestaurantInvoiceItem {
  id            String   @id @default(cuid())
  invoiceId     String
  description   String
  quantity      Decimal  @default(1) @db.Decimal(10,2)
  unitPrice     Decimal  @default(0) @db.Decimal(12,2)
  totalPrice    Decimal  @default(0) @db.Decimal(12,2)
  invoice       RestaurantInvoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  @@index([invoiceId])
  @@map("RestaurantInvoiceItem")
}

model RestaurantInvoicePayment {
  id            String   @id @default(cuid())
  invoiceId     String
  amount        Decimal  @db.Decimal(12,2)
  paymentMethod String
  paidAt        DateTime @default(now())
  notes         String?
  invoice       RestaurantInvoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  @@index([invoiceId])
  @@map("RestaurantInvoicePayment")
}

enum InvoiceType {
  SALE
  PROFORMA
  CREDIT
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  PARTIAL
  OVERDUE
  CANCELLED
}

// ===== შესყიდვების ინვოისი =====

model PurchaseInvoice {
  id              String              @id @default(cuid())
  restaurantId    String
  invoiceNumber   String
  supplierId      String?
  supplierName    String
  supplierTaxId   String?
  issueDate       DateTime            @default(now())
  dueDate         DateTime?
  paidAt          DateTime?
  subtotal        Decimal             @default(0) @db.Decimal(12,2)
  taxAmount       Decimal             @default(0) @db.Decimal(12,2)
  totalAmount     Decimal             @default(0) @db.Decimal(12,2)
  paidAmount      Decimal             @default(0) @db.Decimal(12,2)
  status          PurchaseStatus      @default(PENDING)
  notes           String?
  attachmentUrl   String?
  restaurant      Restaurant          @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  supplier        Supplier?           @relation(fields: [supplierId], references: [id])
  items           PurchaseInvoiceItem[]
  payments        PurchasePayment[]
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  @@index([restaurantId])
  @@index([supplierId])
  @@index([status])
}

model PurchaseInvoiceItem {
  id              String          @id @default(cuid())
  purchaseId      String
  ingredientId    String?
  description     String
  quantity        Decimal         @default(1) @db.Decimal(10,3)
  unit            String?
  unitPrice       Decimal         @default(0) @db.Decimal(12,2)
  totalPrice      Decimal         @default(0) @db.Decimal(12,2)
  purchase        PurchaseInvoice @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  ingredient      Ingredient?     @relation(fields: [ingredientId], references: [id])
  @@index([purchaseId])
}

model PurchasePayment {
  id              String          @id @default(cuid())
  purchaseId      String
  amount          Decimal         @db.Decimal(12,2)
  paymentMethod   String
  paidAt          DateTime        @default(now())
  notes           String?
  purchase        PurchaseInvoice @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  @@index([purchaseId])
}

enum PurchaseStatus {
  PENDING
  PAID
  PARTIAL
  OVERDUE
  CANCELLED
}

// ===== ხარჯები =====

model ExpenseCategory {
  id            String    @id @default(cuid())
  restaurantId  String
  name          String
  icon          String?
  color         String?
  isDefault     Boolean   @default(false)
  restaurant    Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  expenses      Expense[]
  @@unique([restaurantId, name])
  @@index([restaurantId])
}

model Expense {
  id            String          @id @default(cuid())
  restaurantId  String
  categoryId    String
  description   String
  amount        Decimal         @db.Decimal(12,2)
  date          DateTime        @db.Date
  isRecurring   Boolean         @default(false)
  recurringType String?
  paymentMethod String?
  notes         String?
  attachmentUrl String?
  restaurant    Restaurant      @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  category      ExpenseCategory @relation(fields: [categoryId], references: [id])
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  @@index([restaurantId])
  @@index([categoryId])
  @@index([date])
}
