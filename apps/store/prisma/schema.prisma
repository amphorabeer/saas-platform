// Store app uses landing DB (ep-weathered-haze)
// Full Store/POS schema - matches migration add_store_tables

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ── ORGANIZATION & USER (landing) ──

model Organization {
  id         String   @id @default(cuid())
  name       String
  slug       String   @unique
  email      String
  phone      String?
  address    String?
  logo       String?
  company    String?
  taxId      String?
  city       String?
  country    String?  @default("Georgia")
  website    String?
  bankName   String?
  bankAccount String?
  tenantId   String   @unique @default(cuid())
  hotelCode  String   @unique
  storeCode  String?  @unique
  databaseUrl String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  users      User[]

  @@index([slug])
  @@index([tenantId])
}

model User {
  id             String        @id @default(cuid())
  email          String        @unique
  name           String?
  password       String
  avatar         String?
  emailVerified  DateTime?
  lastLoginAt    DateTime?
  organizationId String?
  role           String        @default("USER")
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@index([email])
  @@index([organizationId])
}

// ── STORE ──

model Store {
  id        String    @id @default(cuid())
  tenantId  String
  name      String
  slug      String    @unique
  address   String?
  phone     String?
  email     String?
  taxId     String?
  currency  String    @default("GEL")
  timezone  String    @default("Asia/Tbilisi")
  logoUrl   String?
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  employees       StoreEmployee[]
  products        StoreProduct[]
  categories      ProductCategory[]
  sales           Sale[]
  purchases       StorePurchaseOrder[]
  suppliers       StoreSupplier[]
  customers       StoreCustomer[]
  stockMovements  StockMovement[]
  taxRules        StoreTaxRule[]
  loyaltyConfig   StoreLoyaltyConfig?
  transferOrdersOut TransferOrder[] @relation("TransferFromStore")
  transferOrdersIn  TransferOrder[] @relation("TransferToStore")
  paymentMethods  StorePaymentConfig[]
  receiptConfig   StoreReceiptConfig?
  devices         StoreDeviceConfig[]
  integrations    StoreIntegration[]

  @@index([tenantId])
}

model StoreEmployee {
  id        String   @id @default(cuid())
  storeId   String
  userId    String?
  firstName String
  lastName  String
  phone     String?
  email     String?
  role      String   @default("STORE_CASHIER")
  pin       String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  sales     Sale[]

  @@index([storeId])
}

// ── PRODUCTS ──

model ProductCategory {
  id          String    @id @default(cuid())
  storeId     String
  name        String
  nameKa      String?
  slug        String
  description String?
  color       String?
  icon        String?
  sortOrder   Int       @default(0)
  parentId    String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  store    Store          @relation(fields: [storeId], references: [id], onDelete: Cascade)
  parent   ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children ProductCategory[] @relation("CategoryHierarchy")
  products StoreProduct[]

  @@unique([storeId, slug])
  @@index([storeId])
}

model StoreProduct {
  id             String    @id @default(cuid())
  storeId        String
  categoryId     String?
  sku            String
  barcode        String?
  name           String
  nameKa         String?
  description    String?
  imageUrl       String?
  costPrice      Decimal   @db.Decimal(10, 2)
  sellingPrice   Decimal   @db.Decimal(10, 2)
  wholesalePrice Decimal?  @db.Decimal(10, 2)
  currentStock   Decimal   @default(0) @db.Decimal(10, 3)
  minStock       Decimal   @default(0) @db.Decimal(10, 3)
  maxStock       Decimal?  @db.Decimal(10, 3)
  unit           String    @default("piece")
  taxRuleId      String?
  isActive       Boolean   @default(true)
  isFavorite     Boolean   @default(false)
  sortOrder      Int       @default(0)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  store           Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  category        ProductCategory? @relation(fields: [categoryId], references: [id])
  taxRule         StoreTaxRule?    @relation(fields: [taxRuleId], references: [id])
  saleItems       SaleItem[]
  saleReturnItems SaleReturnItem[]
  purchaseItems   StorePurchaseItem[]
  stockMovements  StockMovement[]
  priceHistory    StorePriceHistory[]
  transferOrderItems TransferOrderItem[]

  @@unique([storeId, sku])
  @@index([storeId])
  @@index([categoryId])
  @@index([barcode])
}

model StorePriceHistory {
  id           String    @id @default(cuid())
  productId    String
  costPrice    Decimal   @db.Decimal(10, 2)
  sellingPrice Decimal   @db.Decimal(10, 2)
  changedBy    String?
  changedAt    DateTime  @default(now())

  product StoreProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

// ── SALES / POS ──

model Sale {
  id             String           @id @default(cuid())
  storeId        String
  saleNumber     String
  customerId     String?
  employeeId     String?
  subtotal       Decimal          @db.Decimal(10, 2)
  taxAmount      Decimal          @default(0) @db.Decimal(10, 2)
  discountAmount Decimal          @default(0) @db.Decimal(10, 2)
  discountType   StoreDiscountType?
  total          Decimal          @db.Decimal(10, 2)
  paidAmount     Decimal          @db.Decimal(10, 2)
  changeAmount   Decimal          @default(0) @db.Decimal(10, 2)
  status         StoreSaleStatus  @default(COMPLETED)
  notes          String?
  receiptPrinted Boolean          @default(false)
  fiscalPrinted  Boolean          @default(false)
  fiscalNumber   String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  store    Store           @relation(fields: [storeId], references: [id], onDelete: Cascade)
  customer StoreCustomer?  @relation(fields: [customerId], references: [id])
  employee StoreEmployee?  @relation(fields: [employeeId], references: [id])
  items    SaleItem[]
  payments SalePayment[]
  returns  SaleReturn[]

  @@unique([storeId, saleNumber])
  @@index([storeId])
  @@index([storeId, createdAt])
  @@index([customerId])
}

model SaleItem {
  id          String   @id @default(cuid())
  saleId      String
  productId   String
  productName String
  quantity    Decimal  @db.Decimal(10, 3)
  unitPrice   Decimal  @db.Decimal(10, 2)
  costPrice   Decimal  @db.Decimal(10, 2)
  discount    Decimal  @default(0) @db.Decimal(10, 2)
  taxAmount   Decimal  @default(0) @db.Decimal(10, 2)
  total       Decimal  @db.Decimal(10, 2)

  sale    Sale         @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product StoreProduct @relation(fields: [productId], references: [id])

  @@index([saleId])
  @@index([productId])
}

model SalePayment {
  id        String        @id @default(cuid())
  saleId    String
  method    PaymentMethod
  amount    Decimal       @db.Decimal(10, 2)
  reference String?
  createdAt DateTime      @default(now())

  sale Sale @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([saleId])
}

model SaleReturn {
  id           String           @id @default(cuid())
  saleId       String
  reason       String
  refundAmount Decimal          @db.Decimal(10, 2)
  refundMethod PaymentMethod
  status       StoreReturnStatus @default(STORE_RETURN_PENDING)
  createdAt    DateTime         @default(now())
  processedAt  DateTime?

  sale  Sale              @relation(fields: [saleId], references: [id], onDelete: Cascade)
  items SaleReturnItem[]

  @@index([saleId])
}

model SaleReturnItem {
  id           String   @id @default(cuid())
  returnId     String
  productId    String
  quantity     Decimal  @db.Decimal(10, 3)
  refundAmount Decimal  @db.Decimal(10, 2)

  saleReturn SaleReturn   @relation(fields: [returnId], references: [id], onDelete: Cascade)
  product    StoreProduct @relation(fields: [productId], references: [id])

  @@index([returnId])
  @@index([productId])
}

// ── PURCHASES / SUPPLIERS ──

model StoreSupplier {
  id            String    @id @default(cuid())
  storeId       String
  name          String
  contactPerson String?
  phone         String?
  email         String?
  address       String?
  taxId         String?
  bankAccount   String?
  notes         String?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  store          Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  purchaseOrders StorePurchaseOrder[]

  @@unique([storeId, name])
  @@index([storeId])
}

model StorePurchaseOrder {
  id           String              @id @default(cuid())
  storeId      String
  supplierId   String
  orderNumber  String
  subtotal     Decimal             @db.Decimal(10, 2)
  taxAmount    Decimal             @default(0) @db.Decimal(10, 2)
  total        Decimal             @db.Decimal(10, 2)
  status       StorePurchaseStatus @default(STORE_PO_DRAFT)
  notes        String?
  expectedDate DateTime?
  receivedDate DateTime?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  store  Store               @relation(fields: [storeId], references: [id], onDelete: Cascade)
  supplier StoreSupplier     @relation(fields: [supplierId], references: [id])
  items  StorePurchaseItem[]

  @@unique([storeId, orderNumber])
  @@index([storeId])
  @@index([supplierId])
}

model StorePurchaseItem {
  id              String             @id @default(cuid())
  purchaseOrderId String
  productId       String
  quantity        Decimal            @db.Decimal(10, 3)
  unitCost        Decimal            @db.Decimal(10, 2)
  receivedQty     Decimal            @default(0) @db.Decimal(10, 3)
  total           Decimal            @db.Decimal(10, 2)

  purchaseOrder StorePurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  product       StoreProduct       @relation(fields: [productId], references: [id])

  @@index([purchaseOrderId])
  @@index([productId])
}

// ── INVENTORY ──

model StockMovement {
  id            String            @id @default(cuid())
  storeId       String
  productId     String
  type          StoreMovementType
  quantity      Decimal           @db.Decimal(10, 3)
  previousStock Decimal           @db.Decimal(10, 3)
  newStock      Decimal           @db.Decimal(10, 3)
  reason        String?
  referenceType String?
  referenceId   String?
  performedBy   String?
  createdAt     DateTime          @default(now())

  store   Store        @relation(fields: [storeId], references: [id], onDelete: Cascade)
  product StoreProduct @relation(fields: [productId], references: [id])

  @@index([storeId])
  @@index([productId])
  @@index([storeId, createdAt])
}

model TransferOrder {
  id             String              @id @default(cuid())
  fromStoreId    String
  toStoreId      String
  transferNumber String
  status         TransferOrderStatus @default(DRAFT)
  notes          String?
  sentAt         DateTime?
  receivedAt     DateTime?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  fromStore Store               @relation("TransferFromStore", fields: [fromStoreId], references: [id], onDelete: Cascade)
  toStore   Store               @relation("TransferToStore", fields: [toStoreId], references: [id], onDelete: Cascade)
  items     TransferOrderItem[]
}

model TransferOrderItem {
  id              String        @id @default(cuid())
  transferOrderId String
  productId       String
  quantity        Decimal       @db.Decimal(10, 3)
  unitCost        Decimal?      @db.Decimal(10, 2)

  transferOrder TransferOrder @relation(fields: [transferOrderId], references: [id], onDelete: Cascade)
  product       StoreProduct  @relation(fields: [productId], references: [id])

  @@index([transferOrderId])
  @@index([productId])
}

// ── CUSTOMERS ──

model StoreCustomer {
  id                    String            @id @default(cuid())
  storeId               String
  firstName             String
  lastName              String?
  phone                 String?
  email                 String?
  address               String?
  taxId                 String?
  notes                 String?
  totalPurchases        Decimal           @default(0) @db.Decimal(10, 2)
  loyaltyPoints         Int               @default(0)
  loyaltyTier           LoyaltyTier       @default(BRONZE)
  totalLifetimePurchases Decimal          @default(0) @db.Decimal(12, 2)
  isActive              Boolean           @default(true)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  store               Store             @relation(fields: [storeId], references: [id], onDelete: Cascade)
  sales               Sale[]
  loyaltyTransactions StoreLoyaltyTransaction[]

  @@index([storeId])
  @@index([phone])
}

model StoreLoyaltyConfig {
  id                   String    @id @default(cuid())
  storeId              String    @unique
  pointsPerGel         Int       @default(1)
  redemptionRate       Int       @default(100)
  minRedemptionPoints  Int       @default(100)
  expirationDays       Int?
  bronzeMinSpend       Decimal?  @db.Decimal(12, 2)
  silverMinSpend       Decimal?  @db.Decimal(12, 2)
  goldMinSpend         Decimal?  @db.Decimal(12, 2)
  platinumMinSpend     Decimal?  @db.Decimal(12, 2)
  goldDiscountPercent  Decimal?  @db.Decimal(5, 2)
  platinumDiscountPercent Decimal? @db.Decimal(5, 2)

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
}

model StoreLoyaltyTransaction {
  id          String                 @id @default(cuid())
  customerId  String
  type        LoyaltyTransactionType
  points      Int
  saleId      String?
  description String?
  createdAt   DateTime               @default(now())

  customer StoreCustomer @relation(fields: [customerId], references: [id], onDelete: Cascade)
}

// ── SETTINGS ──

model StoreTaxRule {
  id        String    @id @default(cuid())
  storeId   String
  name      String
  rate      Decimal   @db.Decimal(5, 2)
  isDefault Boolean   @default(false)
  isActive  Boolean   @default(true)

  store    Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)
  products StoreProduct[]

  @@index([storeId])
}

model StorePaymentConfig {
  id        String        @id @default(cuid())
  storeId   String
  name      String
  type      PaymentMethod
  isActive  Boolean       @default(true)
  sortOrder Int           @default(0)

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId])
}

model StoreReceiptConfig {
  id         String   @id @default(cuid())
  storeId    String   @unique
  headerText String?
  footerText String?
  showLogo   Boolean  @default(true)
  showTaxId  Boolean  @default(true)
  showBarcode Boolean @default(false)
  paperWidth Int      @default(80)

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
}

model StoreDeviceConfig {
  id             String          @id @default(cuid())
  storeId        String
  deviceType     StoreDeviceType
  name           String
  connectionType String
  settings       Json
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId])
}

model StoreIntegration {
  id          String               @id @default(cuid())
  storeId     String
  type        StoreIntegrationType
  name        String
  credentials Json?
  settings    Json?
  lastSyncAt  DateTime?
  isActive    Boolean              @default(true)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId])
}

// ── ENUMS ──

enum LoyaltyTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum LoyaltyTransactionType {
  EARN
  REDEEM
  ADJUST
  EXPIRE
}

enum TransferOrderStatus {
  DRAFT
  SENT
  RECEIVED
}

enum StoreSaleStatus {
  COMPLETED
  VOIDED
  REFUNDED
  PARTIAL_REFUND
}

enum StoreReturnStatus {
  STORE_RETURN_PENDING
  STORE_RETURN_APPROVED
  STORE_RETURN_COMPLETED
  STORE_RETURN_REJECTED
}

enum StorePurchaseStatus {
  STORE_PO_DRAFT
  STORE_PO_ORDERED
  STORE_PO_PARTIAL
  STORE_PO_RECEIVED
  STORE_PO_CANCELLED
}

enum StoreMovementType {
  STOCK_IN
  STOCK_OUT
  STOCK_ADJUSTMENT
  STOCK_TRANSFER
  STOCK_RETURN
}

enum StoreDiscountType {
  DISCOUNT_PERCENTAGE
  DISCOUNT_FIXED
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CARD
  CHECK
}

enum StoreDeviceType {
  RECEIPT_PRINTER
  FISCAL_PRINTER
  BARCODE_SCANNER
  WEIGHT_SCALE
  CASH_DRAWER
  BANK_TERMINAL
  CUSTOMER_DISPLAY
}

enum StoreIntegrationType {
  RS_GE
  WOOCOMMERCE
  SHOPIFY
  GLOVO
  EXTRA_GE
  BANK_TBC
  BANK_BOG
  BANK_LIBERTY
}
