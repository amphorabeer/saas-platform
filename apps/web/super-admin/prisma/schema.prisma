generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
  output        = "./generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ENUMS
enum Role {
  SUPER_ADMIN
  ORGANIZATION_OWNER
  MODULE_ADMIN
  MANAGER
  USER
}

enum ModuleType {
  HOTEL
  RESTAURANT
  BEAUTY
  SHOP
  BREWERY
  WINERY
  DISTILLERY
}

enum PlanType {
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

// MODELS
model Organization {
  id                String             @id @default(cuid())
  name              String
  slug              String             @unique
  email             String
  phone             String?
  address           String?
  logo              String?
  
  // Hotel Info
  company           String?
  taxId             String?
  city              String?
  country           String?            @default("Georgia")
  website           String?
  bankName          String?
  bankAccount       String?

  // Multi-tenancy
  tenantId          String?            @unique // ID from Neon Tenant table (for breweries)
  tenantCode        String?            @unique // BREW-XXXX format code (for breweries)
  hotelCode         String?            @unique // 4-digit code (for hotels)
  storeCode         String?            @unique // shop code
  restCode          String?            @unique // restaurant code
  beautyCode        String?            @unique
  databaseUrl       String?

  // Relations
  subscription      Subscription?
  users             User[]
  modules           ModuleAccess[]
  tickets          SupportTicket[]

  // Timestamps
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@index([slug])
  @@index([tenantId])
  @@index([tenantCode])
}

model User {
  id                String             @id @default(cuid())
  email             String             @unique
  name              String?
  password          String
  avatar            String?
  role              Role               @default(USER)

  // Organization
  organizationId    String?
  organization      Organization?      @relation(fields: [organizationId], references: [id])

  // Auth
  emailVerified     DateTime?
  sessions          Session[]
  accounts          Account[]

  // Activity
  lastLoginAt       DateTime?
  activities        ActivityLog[]

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@index([email])
  @@index([organizationId])
}

model Account {
  id                String             @id @default(cuid())
  userId            String
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?            @db.Text
  access_token      String?            @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?            @db.Text
  session_state     String?

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id                String             @id @default(cuid())
  sessionToken      String             @unique
  userId            String
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires           DateTime

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Subscription {
  id                String             @id @default(cuid())
  organizationId    String             @unique
  organization      Organization       @relation(fields: [organizationId], references: [id])

  plan              PlanType           @default(STARTER)
  status            SubscriptionStatus @default(TRIAL)

  // Pricing
  price             Decimal            @db.Decimal(10, 2)
  currency          String             @default("GEL")

  // Billing
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean           @default(false)

  // Trial
  trialStart        DateTime?
  trialEnd          DateTime?

  // Payment
  paymentMethod     String?
  lastPaymentDate   DateTime?
  nextBillingDate   DateTime?

  // Relations
  invoices          Invoice[]

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@index([organizationId])
  @@index([status])
}

model ModuleAccess {
  id                String             @id @default(cuid())
  organizationId    String
  organization      Organization       @relation(fields: [organizationId], references: [id])

  moduleType        ModuleType
  isActive          Boolean            @default(true)

  // Module-specific settings
  settings          Json?

  // Module limits
  maxUsers          Int?
  maxRecords        Int?

  // Module features
  features          ModuleFeature[]

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@unique([organizationId, moduleType])
  @@index([organizationId])
  @@index([moduleType])
}

model ModuleFeature {
  id                String             @id @default(cuid())
  moduleAccessId    String
  moduleAccess      ModuleAccess       @relation(fields: [moduleAccessId], references: [id])

  name              String
  isEnabled         Boolean            @default(true)

  @@index([moduleAccessId])
}

model Invoice {
  id                String             @id @default(cuid())
  subscriptionId    String
  subscription      Subscription       @relation(fields: [subscriptionId], references: [id])

  invoiceNumber     String             @unique @default(cuid())
  amount            Decimal            @db.Decimal(10, 2)
  currency          String             @default("GEL")
  status            String

  dueDate           DateTime
  paidAt            DateTime?

  invoiceUrl        String?

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@index([subscriptionId])
  @@index([status])
}

// Landing Page Configuration
model ModuleConfig {
  id                String             @id @default(cuid())
  moduleType        ModuleType         @unique
  
  // Display info
  name              String
  nameEn            String?
  nameRu            String?
  
  description       String
  descriptionEn     String?
  descriptionRu     String?
  
  icon              String
  color             String
  isEnabled         Boolean            @default(true)
  displayOrder      Int                @default(0)
  
  // Pricing
  starterPrice      Decimal?           @db.Decimal(10, 2)
  starterDuration   String?            @default("15 დღე")
  starterFeatures   String[]
  
  professionalPrice Decimal?           @db.Decimal(10, 2)
  professionalDuration String?         @default("თვეში")
  professionalFeatures String[]
  
  enterprisePrice   Decimal?           @db.Decimal(10, 2)
  enterpriseDuration String?           @default("თვეში")
  enterpriseFeatures String[]
  
  // Stats
  activeOrganizations Int              @default(0)
  totalUsers        Int                @default(0)
  
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
}

model LandingPageContent {
  id                String             @id @default(cuid())
  key               String             @unique
  
  // Hero section
  heroTitle         String?
  heroSubtitle      String?
  heroDescription   String?
  
  // Statistics
  statsBusinesses   Int?
  statsTransactions Int?
  statsUsers        Int?
  statsUptime       Decimal?           @db.Decimal(5, 2)
  
  // Other content
  content           Json?
  
  updatedAt         DateTime           @updatedAt
}

model SupportTicket {
  id                String             @id @default(cuid())
  
  organizationId    String
  organization      Organization       @relation(fields: [organizationId], references: [id])
  
  subject           String
  description       String             @db.Text
  priority          TicketPriority     @default(MEDIUM)
  status            TicketStatus       @default(OPEN)
  
  assignedTo        String?
  resolvedAt        DateTime?
  
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  
  @@index([organizationId])
  @@index([status])
  @@index([priority])
}

model ActivityLog {
  id                String             @id @default(cuid())
  
  userId            String
  user              User               @relation(fields: [userId], references: [id])
  
  action            String
  details           Json?
  ipAddress         String?
  userAgent         String?
  
  createdAt         DateTime           @default(now())
  
  @@index([userId])
  @@index([action])
}

// Module-specific schemas
model HotelRoom {
  id                String             @id @default(cuid())
  tenantId          String

  roomNumber        String
  roomType          String
  floor             Int
  status            String

  basePrice         Decimal            @db.Decimal(10, 2)

  amenities         String[]
  maxOccupancy      Int

  reservations      HotelReservation[]

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@unique([tenantId, roomNumber])
  @@index([tenantId])
  @@index([status])
}

model HotelReservation {
  id                String             @id @default(cuid())
  tenantId          String

  roomId            String
  room              HotelRoom          @relation(fields: [roomId], references: [id])

  guestName         String
  guestEmail        String?
  guestPhone        String?
  guestCountry      String?

  checkIn           DateTime
  checkOut          DateTime

  adults            Int
  children          Int                @default(0)

  totalAmount       Decimal            @db.Decimal(10, 2)
  paidAmount        Decimal            @db.Decimal(10, 2) @default(0)

  status            String

  // Booking source
  source            String?            @default("Direct")

  // Company fields
  companyName       String?
  companyTaxId      String?
  companyAddress    String?
  companyBank       String?
  companyBankAccount String?

  notes             String?

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@index([tenantId])
  @@index([roomId])
  @@index([status])
}

model Configuration {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@index([key])
}

// Contact Form Submissions from Landing Page
model ContactRequest {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String?
  message   String   @db.Text
  module    String?  // რომელი მოდულიდან მოვიდა (hotel, brewery...)
  status    String   @default("NEW")  // NEW, READ, REPLIED, ARCHIVED
  notes     String?  @db.Text  // ადმინის შენიშვნები
  repliedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([module])
  @@index([createdAt])
}

// ===================================
// GEOGUIDE - Audio Guide Platform
// დაამატე ეს super-admin/prisma/schema.prisma ფაილის ბოლოს
// ===================================

// ENUMS
enum ActivationCodeStatus {
  AVAILABLE    // კოდი ხელმისაწვდომია
  REDEEMED     // კოდი გამოყენებულია
  EXPIRED      // კოდი ვადაგასულია
  REVOKED      // კოდი გაუქმებულია
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum TourPackStatus {
  DRAFT        // შექმნის პროცესში
  PUBLISHED    // გამოქვეყნებული
  ARCHIVED     // არქივირებული
}

// MODELS

// მუზეუმი / ლოკაცია
model Museum {
  id              String          @id @default(cuid())

  // ქართული (ძირითადი)
  name            String
  description     String?         @db.Text
  city            String?
  address         String?

  // ინგლისური
  nameEn          String?
  descriptionEn   String?         @db.Text
  cityEn          String?
  addressEn       String?

  // რუსული
  nameRu          String?
  descriptionRu   String?         @db.Text
  cityRu          String?
  addressRu       String?

  // გერმანული
  nameDe          String?
  descriptionDe   String?         @db.Text
  cityDe          String?
  addressDe       String?

  // ფრანგული
  nameFr          String?
  descriptionFr   String?         @db.Text
  cityFr          String?
  addressFr       String?

  // უკრაინული
  nameUk          String?
  descriptionUk   String?         @db.Text
  cityUk          String?
  addressUk       String?

  // URL და მედია
  slug            String          @unique
  coverImage      String?
  introAudioUrl   String?
  introAudioUrlEn String?
  introAudioUrlRu String?
  introAudioUrlDe String?
  introAudioUrlFr String?
  introAudioUrlUk String?
  gallery         String[]

  // მდებარეობა (კოორდინატები)
  latitude        Float?
  longitude       Float?

  // საკონტაქტო
  contactEmail    String?
  contactPhone    String?
  website         String?

  // სამუშაო საათები
  workingHours    Json?

  // პარამეტრები
  showMap         Boolean         @default(false)
  showQrScanner   Boolean         @default(false)
  isPublished     Boolean         @default(false)
  displayOrder    Int             @default(0)
  category        String?

  // 360° VR Settings
  show360View           Boolean  @default(false)
  vrTourId              String?
  vr360Price            Decimal? @db.Decimal(10, 2)
  vr360IsFree           Boolean  @default(false)
  vr360BundleWithAudio  Boolean  @default(false)

  // რელაციები
  tours           Tour[]
  payments        Payment[]

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([slug])
  @@index([isPublished])
  @@index([category])
}

// ტური
model Tour {
  id              String          @id @default(cuid())
  
  museumId        String
  museum          Museum          @relation(fields: [museumId], references: [id], onDelete: Cascade)
  
  // ძირითადი ინფორმაცია
  name            String
  nameEn          String?
  nameRu          String?
  nameUk          String?
  
  description     String?         @db.Text
  descriptionEn   String?         @db.Text
  descriptionRu   String?         @db.Text
  descriptionUk   String?         @db.Text
  
  // პარამეტრები
  duration        Int?            // წუთებში
  stopsCount      Int             @default(0)
  
  // ფასი
  isFree          Boolean         @default(false)
  price           Decimal?        @db.Decimal(10, 2)
  currency        String          @default("GEL")
  
  // სტატუსი
  isPublished     Boolean         @default(false)
  displayOrder    Int             @default(0)
  
  // ფასი/წვდომა
  allowActivationCodes Boolean    @default(true)
  allowBankPayment     Boolean    @default(true)
  
  // მედია
  coverImage      String?
  vrTourId        String?
  
  // რელაციები
  halls           Hall[]
  stops           TourStop[]
  packs           TourPack[]
  entitlements    Entitlement[]
  payments        Payment[]

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([museumId])
  @@index([isPublished])
}

model Hall {
  id            String     @id @default(cuid())
  tourId        String
  tour          Tour       @relation(fields: [tourId], references: [id], onDelete: Cascade)
  
  name          String
  nameEn        String?
  nameRu        String?
  nameUk        String?
  
  description   String?
  descriptionEn String?
  descriptionRu String?
  descriptionUk String?
  
  floorNumber   Int?
  imageUrl      String?
  orderIndex    Int        @default(0)
  isPublished   Boolean    @default(true)
  
  stops         TourStop[]
  
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
}

// ტურის გაჩერება (Stop/Exhibit)
model TourStop {
  id              String          @id @default(cuid())
  
  tourId          String
  tour            Tour            @relation(fields: [tourId], references: [id], onDelete: Cascade)
  
  hallId          String?
  hall            Hall?           @relation(fields: [hallId], references: [id])
  
  // ძირითადი ინფორმაცია
  title           String
  titleEn         String?
  titleRu         String?
  titleUk         String?
  
  description     String?         @db.Text
  descriptionEn   String?         @db.Text
  descriptionRu   String?         @db.Text
  descriptionUk   String?         @db.Text
  
  // აუდიო ტრანსკრიპტი
  transcript      String?         @db.Text
  transcriptEn    String?         @db.Text
  transcriptRu    String?         @db.Text
  transcriptUk    String?         @db.Text
  
  // მედია
  audioUrl        String?         // აუდიო ფაილის URL
  audioUrlEn      String?
  audioUrlRu      String?
  audioUrlUk      String?
  
  audioDuration   Int?            // წამებში
  
  imageUrl        String?         // სურათი
  images          String[]        // დამატებითი სურათები
  
  // QR კოდი
  qrCode          String?         @unique  // უნიკალური QR კოდი
  
  // თანმიმდევრობა
  orderIndex      Int             @default(0)
  
  // სტატუსი
  isPublished     Boolean         @default(false)
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([tourId])
  @@index([qrCode])
  @@index([orderIndex])
}

// ოფლაინ პაკეტი
model TourPack {
  id              String          @id @default(cuid())
  
  tourId          String
  tour            Tour            @relation(fields: [tourId], references: [id], onDelete: Cascade)
  
  // ენა
  locale          String          // "ka", "en", "ru"
  
  // ვერსია
  version         Int             @default(1)
  
  // ფაილები
  manifestUrl     String?         // manifest.json URL
  totalSize       BigInt?         // ბაიტებში
  
  // სტატუსი
  status          TourPackStatus  @default(DRAFT)
  
  // Build info
  builtAt         DateTime?
  buildLog        String?         @db.Text
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@unique([tourId, locale])
  @@index([tourId])
  @@index([status])
}

// აქტივაციის კოდი
model ActivationCode {
  id              String                  @id @default(cuid())
  
  // კოდი (hashed)
  code            String                  @unique  // დისპლეისთვის: "GEOG-XXXX-XXXX"
  codeHash        String                  @unique  // SHA256 hash ვერიფიკაციისთვის
  
  // ვადა
  durationDays    Int                     // რამდენი დღე მოქმედებს
  
  // სტატუსი
  status          ActivationCodeStatus    @default(AVAILABLE)
  
  // ტურები რომლებზეც წვდომა აქვს
  tourIds         String[]                // ცარიელი = ყველა ტური
  museumIds       String[]                // ცარიელი = ყველა მუზეუმი
  
  // Redeem ინფორმაცია
  redeemedAt      DateTime?
  redeemedBy      String?                 // deviceId
  
  // Batch ინფორმაცია (ჯგუფური გენერაციისთვის)
  batchId         String?
  batchName       String?
  
  // მეტადატა
  notes           String?
  
  // რელაცია
  entitlement     Entitlement?
  payments        Payment[]

  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt

  @@index([code])
  @@index([codeHash])
  @@index([status])
  @@index([batchId])
}

// მოწყობილობა
model Device {
  id              String          @id @default(cuid())
  
  deviceId        String          @unique  // უნიკალური მოწყობილობის ID
  
  // მოწყობილობის ინფო
  platform        String?         // "ios", "android", "web"
  deviceName      String?
  appVersion      String?
  
  // Push notifications
  pushToken       String?
  
  // რელაციები
  entitlements    Entitlement[]
  
  // აქტივობა
  lastActiveAt    DateTime?
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([deviceId])
}

// უფლებამოსილება (Device + Tour წვდომა)
model Entitlement {
  id              String          @id @default(cuid())

  deviceId        String
  device          Device          @relation(fields: [deviceId], references: [id])

  tourId          String
  tour            Tour            @relation(fields: [tourId], references: [id])

  // ტიპი: AUDIO (აუდიო ტური) ან VR360 (360° ვირტუალური ტური)
  type            String          @default("AUDIO")  // "AUDIO" | "VR360"

  // აქტივაციის კოდი
  activationCodeId String?        @unique
  activationCode  ActivationCode? @relation(fields: [activationCodeId], references: [id])

  // ვადა
  activatedAt     DateTime        @default(now())
  expiresAt       DateTime

  // სტატუსი
  isActive        Boolean         @default(true)
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@unique([deviceId, tourId])
  @@index([deviceId])
  @@index([tourId])
  @@index([expiresAt])
  @@index([isActive])
}

// გადახდა (TBC Pay / ტურის შეძენა)
model Payment {
  id                String          @id @default(cuid())
  orderId           String          @unique
  tbcPaymentId      String?
  tbcStatus         String?
  tourId            String
  tour              Tour            @relation(fields: [tourId], references: [id])
  museumId          String?
  museum            Museum?         @relation(fields: [museumId], references: [id])
  deviceId          String
  amount            Decimal         @db.Decimal(10, 2)
  currency          String          @default("GEL")
  status            PaymentStatus  @default(PENDING)
  activationCodeId  String?
  activationCode    ActivationCode? @relation(fields: [activationCodeId], references: [id])
  completedAt       DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
}

// ანალიტიკა (Optional)
model GeoGuideEvent {
  id              String          @id @default(cuid())
  
  deviceId        String?
  tourId          String?
  stopId          String?
  museumId        String?
  
  // Event type
  eventType       String          // "tour_start", "stop_play", "download", "qr_scan"
  
  // მეტადატა
  metadata        Json?
  
  // Location (optional)
  latitude        Decimal?        @db.Decimal(10, 8)
  longitude       Decimal?        @db.Decimal(11, 8)
  
  createdAt       DateTime        @default(now())
  
  @@index([deviceId])
  @@index([tourId])
  @@index([eventType])
  @@index([createdAt])
}

// =============================================
// GeoGuide RAG Chatbot
// =============================================

// RAG კონტენტის chunks
model GeoGuideChunk {
  id          String   @id @default(cuid())
  tourId      String
  stopId      String?
  museumId    String

  language    String   // ka, en, ru
  title       String
  content     String   @db.Text
  chunkIndex  Int

  keywords    String[]
  hallName    String?
  stopNumber  Int?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tourId])
  @@index([museumId, language])
  @@index([museumId])
  @@index([language])
  @@map("geoguide_chunks")
}

// ჩატის სესიები
model GeoGuideChatSession {
  id           String   @id @default(cuid())
  museumId     String
  tourId       String?
  language     String   @default("ka")

  sessionToken String   @unique
  deviceType   String?

  messages     GeoGuideChatMessage[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([museumId])
  @@index([createdAt])
  @@map("geoguide_chat_sessions")
}

// ჩატის შეტყობინებები
model GeoGuideChatMessage {
  id         String   @id @default(cuid())
  sessionId  String
  session    GeoGuideChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  role       String   // user | assistant
  content    String   @db.Text

  chunksUsed String[]
  tokensUsed Int?

  createdAt  DateTime @default(now())

  @@index([sessionId])
  @@map("geoguide_chat_messages")
}
