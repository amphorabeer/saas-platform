generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id                  String               @id @default(cuid())
  name                String
  slug                String               @unique
  email               String
  phone               String?
  address             String?
  logo                String?
  company             String?
  taxId               String?
  city                String?
  country             String?              @default("Georgia")
  website             String?
  bankName            String?
  bankAccount         String?
  tenantId            String               @unique @default(cuid())
  hotelCode           String               @unique
  databaseUrl         String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  cashierShifts       CashierShift[]
  channelConnections  ChannelConnection[]
  chargeItems         ChargeItem[]
  emailQueue          EmailQueue[]
  facebookIntegration FacebookIntegration?
  floors              Floor[]
  folios              Folio[]
  folioRoutingRules   FolioRoutingRule[]
  hotelSettings       HotelSettings?
  housekeepingTasks   HousekeepingTask[]
  maintenanceRooms    MaintenanceRoom[]
  modules             ModuleAccess[]
  nightAudits         NightAudit[]
  paymentTransactions PaymentTransaction[]
  quickButtons        QuickButton[]
  roomTypes           RoomType[]
  subscription        Subscription?
  tickets             SupportTicket[]
  users               User[]

  @@index([slug])
  @@index([tenantId])
}

model User {
  id               String        @id @default(cuid())
  email            String        @unique
  name             String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  password         String
  avatar           String?
  emailVerified    DateTime?
  lastLoginAt      DateTime?
  organizationId   String?
  role             Role          @default(USER)
  resetToken       String?
  resetTokenExpiry DateTime?
  accounts         Account[]
  activities       ActivityLog[]
  sessions         Session[]
  organization     Organization? @relation(fields: [organizationId], references: [id])

  @@index([email])
  @@index([organizationId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Subscription {
  id                 String             @id @default(cuid())
  organizationId     String             @unique
  plan               PlanType           @default(STARTER)
  status             SubscriptionStatus @default(TRIAL)
  price              Decimal            @db.Decimal(10, 2)
  currency           String             @default("GEL")
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean            @default(false)
  trialStart         DateTime?
  trialEnd           DateTime?
  paymentMethod      String?
  lastPaymentDate    DateTime?
  nextBillingDate    DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  invoices           Invoice[]
  organization       Organization       @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([status])
}

model ModuleAccess {
  id             String          @id @default(cuid())
  organizationId String
  moduleType     ModuleType
  isActive       Boolean         @default(true)
  settings       Json?
  maxUsers       Int?
  maxRecords     Int?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  organization   Organization    @relation(fields: [organizationId], references: [id])
  features       ModuleFeature[]

  @@unique([organizationId, moduleType])
  @@index([organizationId])
  @@index([moduleType])
}

model ModuleFeature {
  id             String       @id @default(cuid())
  moduleAccessId String
  name           String
  isEnabled      Boolean      @default(true)
  moduleAccess   ModuleAccess @relation(fields: [moduleAccessId], references: [id])

  @@index([moduleAccessId])
}

model Invoice {
  id             String       @id @default(cuid())
  invoiceNumber  String       @unique @default(cuid())
  dueDate        DateTime
  paidAt         DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  amount         Decimal      @db.Decimal(10, 2)
  currency       String       @default("GEL")
  invoiceUrl     String?
  subscriptionId String
  status         String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])

  @@index([subscriptionId])
  @@index([status])
}

model ModuleConfig {
  id                   String     @id @default(cuid())
  moduleType           ModuleType @unique
  name                 String
  nameEn               String?
  nameRu               String?
  description          String
  descriptionEn        String?
  descriptionRu        String?
  icon                 String
  color                String
  isEnabled            Boolean    @default(true)
  displayOrder         Int        @default(0)
  starterPrice         Decimal?   @db.Decimal(10, 2)
  starterDuration      String?    @default("15 დღე")
  starterFeatures      String[]
  professionalPrice    Decimal?   @db.Decimal(10, 2)
  professionalDuration String?    @default("თვეში")
  professionalFeatures String[]
  enterprisePrice      Decimal?   @db.Decimal(10, 2)
  enterpriseDuration   String?    @default("თვეში")
  enterpriseFeatures   String[]
  activeOrganizations  Int        @default(0)
  totalUsers           Int        @default(0)
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt
}

model LandingPageContent {
  id                String   @id @default(cuid())
  key               String   @unique
  heroTitle         String?
  heroSubtitle      String?
  heroDescription   String?
  statsBusinesses   Int?
  statsTransactions Int?
  statsUsers        Int?
  statsUptime       Decimal? @db.Decimal(5, 2)
  content           Json?
  updatedAt         DateTime @updatedAt
}

model SupportTicket {
  id             String         @id @default(cuid())
  organizationId String
  subject        String
  description    String
  priority       TicketPriority @default(MEDIUM)
  status         TicketStatus   @default(OPEN)
  assignedTo     String?
  resolvedAt     DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  organization   Organization   @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([status])
  @@index([priority])
}

model ActivityLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  details   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
}

model HotelRoom {
  id           String             @id @default(cuid())
  tenantId     String
  roomNumber   String
  roomType     String
  floor        Int
  status       String
  basePrice    Decimal            @db.Decimal(10, 2)
  amenities    String[]
  maxOccupancy Int
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  reservations HotelReservation[]

  @@unique([tenantId, roomNumber])
  @@index([tenantId])
  @@index([status])
}

model HotelReservation {
  id                 String    @id @default(cuid())
  tenantId           String
  roomId             String
  guestName          String
  guestEmail         String?
  guestPhone         String?
  guestCountry       String?
  checkIn            DateTime
  checkOut           DateTime
  adults             Int
  children           Int       @default(0)
  totalAmount        Decimal   @db.Decimal(10, 2)
  paidAmount         Decimal   @default(0) @db.Decimal(10, 2)
  status             String
  source             String?   @default("Direct")
  companyName        String?
  companyTaxId       String?
  companyAddress     String?
  companyBank        String?
  companyBankAccount String?
  notes              String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  room               HotelRoom @relation(fields: [roomId], references: [id])

  @@index([tenantId])
  @@index([roomId])
  @@index([status])
}

model Configuration {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@index([key])
}

model NightAudit {
  id                String       @id @default(cuid())
  organizationId    String
  date              String
  status            String       @default("completed")
  completedAt       DateTime?
  closedAt          DateTime?
  closedBy          String?
  user              String?
  checkIns          Int          @default(0)
  checkOuts         Int          @default(0)
  noShows           Int          @default(0)
  totalRooms        Int          @default(0)
  occupiedRooms     Int          @default(0)
  occupancy         Float        @default(0)
  revenue           Float        @default(0)
  roomChargesPosted Int          @default(0)
  roomChargeTotal   Float        @default(0)
  packagesPosted    Int          @default(0)
  packageTotal      Float        @default(0)
  foliosClosed      Int          @default(0)
  paymentsTotal     Float        @default(0)
  taxesTotal        Float        @default(0)
  outstanding       Float        @default(0)
  auditData         Json?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, date])
  @@index([organizationId])
  @@index([date])
}

model Folio {
  id             String       @id @default(cuid())
  organizationId String
  folioNumber    String
  guestName      String
  roomNumber     String?
  reservationId  String?
  status         String       @default("open")
  folioType      String       @default("guest")
  totalCharges   Float        @default(0)
  totalPayments  Float        @default(0)
  balance        Float        @default(0)
  checkIn        DateTime?
  checkOut       DateTime?
  closedAt       DateTime?
  charges        Json?
  payments       Json?
  folioData      Json?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, folioNumber])
  @@index([organizationId])
  @@index([status])
  @@index([roomNumber])
}

model CashierShift {
  id             String       @id @default(cuid())
  organizationId String
  shiftNumber    String
  cashierName    String
  cashierId      String?
  status         String       @default("open")
  openedAt       DateTime     @default(now())
  openingBalance Float        @default(0)
  closedAt       DateTime?
  closingBalance Float?
  totalCashIn    Float        @default(0)
  totalCashOut   Float        @default(0)
  totalCard      Float        @default(0)
  totalBank      Float        @default(0)
  transactions   Json?
  shiftData      Json?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([status])
}

model PaymentTransaction {
  id                String       @id @default(cuid())
  organizationId    String
  transactionNumber String
  folioId           String?
  folioNumber       String?
  type              String
  method            String
  amount            Float
  guestName         String?
  roomNumber        String?
  description       String?
  cashierShiftId    String?
  cashierName       String?
  transactionDate   DateTime     @default(now())
  transactionData   Json?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([folioId])
  @@index([transactionDate])
}

model ChargeItem {
  id             String       @id @default(cuid())
  organizationId String
  code           String
  name           String
  nameEn         String?
  category       String
  price          Float        @default(0)
  taxRate        Float        @default(0)
  isActive       Boolean      @default(true)
  itemData       Json?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([category])
}

model FolioRoutingRule {
  id               String       @id @default(cuid())
  organizationId   String
  name             String
  sourceRoomNumber String?
  targetFolioId    String?
  chargeCategories String[]
  isActive         Boolean      @default(true)
  ruleData         Json?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

model HotelSettings {
  id             String       @id @default(cuid())
  organizationId String       @unique
  hotelName      String?
  address        String?
  city           String?
  country        String?
  phone          String?
  email          String?
  website        String?
  logo           String?
  taxId          String?
  bankName       String?
  bankAccount    String?
  currency       String       @default("GEL")
  checkInTime    String?      @default("14:00")
  checkOutTime   String?      @default("12:00")
  timezone       String?      @default("Asia/Tbilisi")
  settingsData   Json?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model RoomType {
  id             String       @id @default(cuid())
  organizationId String
  code           String
  name           String
  nameEn         String?
  basePrice      Float        @default(0)
  maxOccupancy   Int          @default(2)
  amenities      String[]
  description    String?
  isActive       Boolean      @default(true)
  typeData       Json?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, code])
  @@index([organizationId])
}

model Floor {
  id             String       @id @default(cuid())
  organizationId String
  floorNumber    Int
  name           String?
  isActive       Boolean      @default(true)
  floorData      Json?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, floorNumber])
  @@index([organizationId])
}

model HousekeepingTask {
  id             String       @id @default(cuid())
  organizationId String
  roomNumber     String
  taskType       String
  status         String       @default("pending")
  assignedTo     String?
  priority       String       @default("normal")
  notes          String?
  completedAt    DateTime?
  completedBy    String?
  taskDate       DateTime     @default(now())
  taskData       Json?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([roomNumber])
  @@index([status])
  @@index([taskDate])
}

model MaintenanceRoom {
  id             String       @id @default(cuid())
  organizationId String
  roomNumber     String
  reason         String
  startDate      DateTime
  endDate        DateTime?
  status         String       @default("out_of_order")
  notes          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([roomNumber])
  @@index([status])
}

model QuickButton {
  id             String       @id @default(cuid())
  organizationId String
  name           String
  code           String
  category       String
  price          Float        @default(0)
  position       Int          @default(0)
  color          String?
  icon           String?
  isActive       Boolean      @default(true)
  buttonData     Json?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

model EmailQueue {
  id             String       @id @default(cuid())
  organizationId String
  toEmail        String
  subject        String
  body           String
  status         String       @default("pending")
  sentAt         DateTime?
  errorMessage   String?
  emailData      Json?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([status])
}

model Channel {
  id                   String              @id @default(cuid())
  name                 String
  type                 ChannelType         @unique
  logo                 String?
  description          String?
  connectorType        String              @default("ical")
  supportsRates        Boolean             @default(false)
  supportsAvailability Boolean             @default(true)
  supportsBookings     Boolean             @default(false)
  isActive             Boolean             @default(true)
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  connections          ChannelConnection[]
}

model ChannelConnection {
  id                  String                  @id @default(cuid())
  organizationId      String
  channelId           String
  status              ChannelConnectionStatus @default(PENDING)
  importUrl           String?
  exportUrl           String?
  apiKey              String?
  apiSecret           String?
  propertyId          String?
  syncDirection       SyncDirection           @default(BIDIRECTIONAL)
  syncIntervalMinutes Int                     @default(30)
  lastSyncAt          DateTime?
  lastSyncStatus      String?
  lastSyncError       String?
  defaultRoomTypeId   String?
  isActive            Boolean                 @default(true)
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  bookings            ChannelBooking[]
  channel             Channel                 @relation(fields: [channelId], references: [id])
  organization        Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  roomMappings        ChannelRoomMapping[]
  syncLogs            ChannelSyncLog[]

  @@unique([organizationId, channelId])
  @@index([organizationId])
  @@index([channelId])
  @@index([status])
}

model ChannelRoomMapping {
  id                 String            @id @default(cuid())
  connectionId       String
  roomId             String
  channelListingId   String?
  channelListingName String?
  icalImportUrl      String?
  icalExportUrl      String?
  syncAvailability   Boolean           @default(true)
  syncRates          Boolean           @default(false)
  isActive           Boolean           @default(true)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  connection         ChannelConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@unique([connectionId, roomId])
  @@unique([connectionId, channelListingId])
  @@index([connectionId])
  @@index([roomId])
}

model ChannelBooking {
  id                 String               @id @default(cuid())
  connectionId       String
  channelBookingId   String
  channelGuestName   String?
  localReservationId String?
  roomId             String?
  checkIn            DateTime
  checkOut           DateTime
  guestName          String?
  guestEmail         String?
  guestPhone         String?
  adults             Int                  @default(1)
  children           Int                  @default(0)
  totalAmount        Decimal?             @db.Decimal(10, 2)
  currency           String?
  status             ChannelBookingStatus @default(PENDING)
  rawData            Json?
  isProcessed        Boolean              @default(false)
  processedAt        DateTime?
  processingError    String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  connection         ChannelConnection    @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@unique([connectionId, channelBookingId])
  @@index([connectionId])
  @@index([status])
  @@index([checkIn, checkOut])
}

model ChannelSyncLog {
  id             String            @id @default(cuid())
  connectionId   String
  syncType       String
  direction      SyncDirection
  status         String
  itemsProcessed Int               @default(0)
  itemsSucceeded Int               @default(0)
  itemsFailed    Int               @default(0)
  startedAt      DateTime          @default(now())
  completedAt    DateTime?
  errorMessage   String?
  details        Json?
  connection     ChannelConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@index([connectionId])
  @@index([startedAt])
}

model FacebookIntegration {
  id               String       @id @default(cuid())
  organizationId   String       @unique
  pageId           String       @unique
  pageName         String?
  pageAccessToken  String
  verifyToken      String       @default(cuid())
  isActive         Boolean      @default(true)
  autoReply        Boolean      @default(true)
  welcomeMessage   String?
  botEnabled       Boolean      @default(true)
  bookingEnabled   Boolean      @default(true)
  messagesReceived Int          @default(0)
  messagesSent     Int          @default(0)
  bookingsCreated  Int          @default(0)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([pageId])
}

enum Role {
  SUPER_ADMIN
  ORGANIZATION_OWNER
  MODULE_ADMIN
  MANAGER
  USER
}

enum ModuleType {
  HOTEL
  RESTAURANT
  BEAUTY
  SHOP
  BREWERY
  WINERY
  DISTILLERY
}

enum PlanType {
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum ChannelType {
  ICAL
  BOOKING_COM
  AIRBNB
  EXPEDIA
  AGODA
  SITEMINDER
  CLOUDBEDS
  CUSTOM
}

enum ChannelConnectionStatus {
  ACTIVE
  INACTIVE
  ERROR
  PENDING
}

enum ChannelBookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  MODIFIED
}

enum SyncDirection {
  IMPORT
  EXPORT
  BIDIRECTIONAL
}
